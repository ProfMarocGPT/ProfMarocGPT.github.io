<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfMarocGPT Lesson Summaries</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'morocco-blue': '#1a2e4f',
                        'morocco-gold': '#ffc107',
                        'morocco-green': '#008000',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loading-dots div {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background-color: #ffc107;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots div:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        /* Ensure Arabic/Darija content displays right-to-left */
        .rtl { direction: rtl; text-align: right; }

        /* Style for the citation container */
        .citations-container {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .citation-link {
            color: #1a2e4f;
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10 p-6 bg-morocco-blue text-white rounded-xl shadow-lg">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-1">ProfMarocGPT üá≤üá¶</h1>
            <p class="text-morocco-gold text-lg">ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÑÿ™ÿπŸÑŸÖ ŸÖÿ™ŸÖŸäÿ≤ ŸàŸáÿßÿØŸÅ.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Control Panel (Input) -->
            <section class="lg:col-span-1 p-6 bg-white rounded-xl shadow-2xl h-fit sticky top-8">
                <h2 class="text-2xl font-bold text-morocco-blue mb-5 border-b pb-3">Lesson Details</h2>

                <div class="space-y-4">
                    <!-- Grade Select -->
                    <div>
                        <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Grade Level</label>
                        <select id="grade" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                            <option value="Primary School (CP, CE1, CE2)">Primary School</option>
                            <option value="Middle School (Coll√®ge)">Middle School</option>
                            <option value="High School (Lyc√©e)">High School</option>
                            <option value="University/Higher Education">University/Higher Education</option>
                        </select>
                    </div>

                    <!-- Subject Input -->
                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                        <input type="text" id="subject" value="Physics" placeholder="e.g., Arabic Language, Physics, History" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                    </div>

                    <!-- Lesson Input -->
                    <div>
                        <label for="lesson" class="block text-sm font-medium text-gray-700 mb-1">Lesson Topic / Title</label>
                        <input type="text" id="lesson" value="Les Atomes et Les Ions" placeholder="e.g., Photosynthesis, Verb Conjugation, Fractions" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                    </div>
                    
                    <!-- Resource Type (Hidden and fixed to 'summary') -->
                    <input type="hidden" id="outputType" value="summary">
                    
                    <!-- Output Language Select -->
                    <div>
                        <label for="outputLanguage" class="block text-sm font-medium text-gray-700 mb-1">Output Language</label>
                        <select id="outputLanguage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                            <option value="Standard Arabic">Standard Arabic (ÿßŸÑŸÅÿµÿ≠Ÿâ)</option>
                            <option value="Moroccan Arabic (Darija)">Moroccan Arabic (ÿßŸÑÿØÿßÿ±ÿ¨ÿ©)</option>
                            <option value="French">French (Fran√ßais)</option>
                            <option value="English">English</option>
                        </select>
                    </div>

                    <!-- Generate Button -->
                    <button id="generateBtn"
                            class="w-full py-3 px-4 bg-morocco-green text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50">
                        Generate Summary
                    </button>
                </div>
            </section>

            <!-- Output Display -->
            <section class="lg:col-span-2 p-6 bg-white rounded-xl shadow-2xl">
                <h2 id="outputTitle" class="text-2xl font-bold text-morocco-blue mb-5 border-b pb-3">Generated Content</h2>

                <div id="loadingIndicator" class="hidden loading-dots my-10">
                    <div class="h-4 w-4"></div>
                    <div class="h-4 w-4"></div>
                    <div class="h-4 w-4"></div>
                </div>

                <div id="outputContainer" class="text-gray-700 space-y-4">
                    <p class="text-center text-gray-500 italic">Select your lesson details and click "Generate" to create a new summary.</p>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        // Gemini API Configuration
        const apiKey = "AIzaSyDr-16AZfW9ucQO2_UVltXQz65aDh1ppiw"; // Leave as-is, the environment provides the key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Utility Functions and DOM Elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const outputContainer = document.getElementById('outputContainer');
        const generateBtn = document.getElementById('generateBtn');
        const outputTitle = document.getElementById('outputTitle');

        /**
         * Exponential backoff for API retries.
         * @param {number} attempt
         * @returns {Promise<void>}
         */
        const wait = (attempt) => new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 500));

        /**
         * Constructs the system prompt and user query based on user inputs.
         * @param {string} grade
         * @param {string} subject
         * @param {string} lesson
         * @param {string} outputLanguage
         * @returns {{systemInstruction: string, userQuery: string}}
         */
        function buildPrompts(grade, subject, lesson, outputLanguage) {
            // STRONGLY ENFORCED plain text output to fix the Markdown/LaTeX rendering issue.
            // NEW INSTRUCTION: Focus the search on Moroccan context.
            const baseInstruction = `You are an expert pedagogical assistant for Moroccan teachers. Your task is to generate a concise, easy-to-read lesson summary suitable for comprehension check. The complexity must be appropriate for a ${grade} level, focusing on the subject of ${subject} as taught in the Moroccan curriculum.
            
            **CRITICAL FORMATTING RULES:**
            1. The output must be **plain, clean text**.
            2. **DO NOT** use any Markdown formatting characters (like *, **, #, ##, ###, >, ---, |).
            3. **DO NOT** use any LaTeX or mathematical notation symbols (like $$, \\, \text). Use words (e.g., "Positive charge") instead of symbols (e.g., $Na^+$).
            4. The entire response MUST be generated in ${outputLanguage}.
            
            **CRITICAL CONTENT RULE:**
            The summary must be accurate and **grounded in information from Moroccan educational or curriculum resources**, using Google Search as a tool to find relevant, localized data for the topic.`;

            const userQuery = `Generate the simple, easy-to-comprehend lesson summary for the topic: "${lesson}".`;
            
            return {
                systemInstruction: baseInstruction,
                userQuery: userQuery
            };
        }

        /**
         * Extracts and formats grounding sources from the API response.
         * @param {object} result - The full API response object.
         * @returns {Array<object>} Formatted array of sources.
         */
        function extractSources(result) {
            let sources = [];
            const groundingMetadata = result?.candidates?.[0]?.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title); 
            }
            return sources;
        }

        /**
         * Renders the generated content and citations.
         * @param {string} content - The raw text summary.
         * @param {Array<object>} sources - Array of sources for citation.
         * @param {string} outputLanguage 
         */
        function renderContent(content, sources, outputLanguage) {
            outputContainer.innerHTML = '';
            
            // Determine text direction for Arabic/Darija
            const isRTL = outputLanguage.includes('Arabic');
            outputContainer.className = `text-gray-700 space-y-6 ${isRTL ? 'rtl' : ''}`;
            
            outputTitle.textContent = "Lesson Summary";
            
            // Replaces common Markdown list indicators with simple HTML formatting
            let cleanContent = content.replace(/^- /gm, '‚Ä¢ ').replace(/^\* /gm, '‚Ä¢ ');

            let summaryHtml = `
                <div class="p-4 bg-gray-50 border-l-4 border-morocco-blue rounded-r-lg 
                    ${isRTL ? 'border-r-4 border-l-0 rounded-l-lg rounded-r-none' : ''}">
                    <p class="text-lg whitespace-pre-wrap leading-relaxed">${cleanContent}</p>
                </div>
            `;

            // Append citations if available
            if (sources.length > 0) {
                const sourceList = sources.map((source, index) => {
                    const displayTitle = source.title ? source.title : 'Source Link';
                    return `<li class="mt-1 ${isRTL ? 'list-none' : 'list-decimal list-inside'}">
                        <a href="${source.uri}" target="_blank" class="citation-link hover:text-morocco-green">${displayTitle}</a>
                    </li>`;
                }).join('');

                const citationBlock = `
                    <div class="citations-container ${isRTL ? 'rtl' : 'ltr'}">
                        <p class="font-semibold mb-2">Sources Referenced (ŸÑŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™):</p>
                        <ol class="pl-0">${sourceList}</ol>
                    </div>
                `;
                summaryHtml += citationBlock;
            }

            outputContainer.innerHTML = summaryHtml;
        }

        // Main Content Generation Function
        async function generateContent() {
            const grade = document.getElementById('grade').value;
            const subject = document.getElementById('subject').value.trim();
            const lesson = document.getElementById('lesson').value.trim();
            const outputLanguage = document.getElementById('outputLanguage').value;

            if (!subject || !lesson) {
                outputContainer.innerHTML = '<p class="text-red-500 text-center">Please provide a Subject and a Lesson Topic.</p>';
                return;
            }

            // UI State Change (Loading)
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            outputContainer.innerHTML = '';
            loadingIndicator.classList.remove('hidden');

            const { systemInstruction, userQuery } = buildPrompts(grade, subject, lesson, outputLanguage);
            
            // NEW: Add Google Search Grounding tool
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                tools: [{ "google_search": {} }] // THIS ENABLES SEARCH
            };
            
            // Exponential backoff loop
            let response, result;
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    await wait(attempt);
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        result = await response.json();
                        break; 
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        continue;
                    } else {
                        throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    result = { error: error.message }; 
                    break;
                }
            }


            // UI State Change (Finished)
            loadingIndicator.classList.add('hidden');
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Summary';

            if (result.error) {
                outputContainer.innerHTML = `<p class="text-red-500 text-center">Generation Failed: ${result.error}</p>`;
                return;
            }

            try {
                const textPart = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                const sources = extractSources(result);

                if (!textPart) {
                    throw new Error("Received an empty response from the AI.");
                }

                // Render the clean plain text summary with sources
                renderContent(textPart, sources, outputLanguage);

            } catch (e) {
                console.error("Error processing AI response:", e);
                console.log("Raw Text Received:", result?.candidates?.[0]?.content?.parts?.[0]?.text);
                outputContainer.innerHTML = `<p class="text-red-500 text-center">Error: Could not process AI response. Please check the console for details.</p>`;
            }
        }
        
        // Attach event listener directly using JavaScript from the module scope.
        generateBtn.addEventListener('click', generateContent);
    </script>
</body>
</html>
