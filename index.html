<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfMarocGPT V1.5</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ‚úÖ MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'morocco-blue': '#1a2e4f',
                        'morocco-gold': '#ffc107',
                        'morocco-green': '#008000',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loading-dots div {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background-color: #ffc107;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots div:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        .rtl { direction: rtl; text-align: right; }

        @media print {
            .no-print { display: none !important; }
            main.grid { display: block; }
            section.lg\:col-span-2 { width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10 p-6 bg-morocco-blue text-white rounded-xl shadow-lg no-print">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-1">ProfMarocGPT V1.5 üá≤üá¶</h1>
            <p class="text-morocco-gold text-lg">ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÑÿ™ÿπŸÑŸÖ ŸÖÿ™ŸÖŸäÿ≤ ŸàŸáÿßÿØŸÅ.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <section class="lg:col-span-1 p-6 bg-white rounded-xl shadow-2xl h-fit sticky top-8 no-print">
                <h2 class="text-2xl font-bold text-morocco-blue mb-5 border-b pb-3">Lesson Details</h2>

                <div class="space-y-4">
                    <div>
                        <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Grade Level</label>
                        <select id="grade" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue">
                            <option value="Primary School (CP, CE1, CE2)">Primary School</option>
                            <option value="Middle School (Coll√®ge)">Middle School</option>
                            <option value="High School (Lyc√©e)">High School</option>
                            <option value="University/Higher Education">University/Higher Education</option>
                        </select>
                    </div>

                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                        <input type="text" id="subject" value="Physics" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue">
                    </div>

                    <div>
                        <label for="lesson" class="block text-sm font-medium text-gray-700 mb-1">Lesson Topic / Title</label>
                        <input type="text" id="lesson" value="Les Atomes et Les Ions" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue">
                    </div>

                    <div>
                        <label for="outputType" class="block text-sm font-medium text-gray-700 mb-1">Resource Type</label>
                        <select id="outputType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue">
                            <option value="summary">Simple Lesson Summary (Text)</option>
                            <option value="presentation">Presentation Outline (Slides)</option>
                        </select>
                    </div>

                    <div>
                        <label for="outputLanguage" class="block text-sm font-medium text-gray-700 mb-1">Output Language</label>
                        <select id="outputLanguage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue">
                            <option value="Standard Arabic">Standard Arabic (ÿßŸÑŸÅÿµÿ≠Ÿâ)</option>
                            <option value="Moroccan Arabic (Darija)">Moroccan Arabic (ÿßŸÑÿØÿßÿ±ÿ¨ÿ©)</option>
                            <option value="French">French (Fran√ßais)</option>
                            <option value="English">English</option>
                        </select>
                    </div>

                    <button id="generateBtn" class="w-full py-3 px-4 bg-morocco-green text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                        Generate Resource
                    </button>
                </div>
            </section>

            <section class="lg:col-span-2 p-6 bg-white rounded-xl shadow-2xl">
                <h2 id="outputTitle" class="text-2xl font-bold text-morocco-blue mb-5 border-b pb-3">Generated Content</h2>

                <div class="text-right mb-4">
                    <button id="printBtn" class="hidden py-2 px-4 bg-morocco-blue text-white text-sm font-semibold rounded-lg shadow-md hover:bg-blue-700 no-print">
                        üñ®Ô∏è Print Resource
                    </button>
                </div>

                <div id="loadingIndicator" class="hidden loading-dots my-10">
                    <div class="h-4 w-4"></div><div class="h-4 w-4"></div><div class="h-4 w-4"></div>
                </div>

                <div id="outputContainer" class="text-gray-700 space-y-4">
                    <p class="text-center text-gray-500 italic">Select your lesson details and click "Generate" to create a new resource.</p>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        const apiKey = "AIzaSyDr-16AZfW9ucQO2_UVltXQz65aDh1ppiw";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const loadingIndicator = document.getElementById('loadingIndicator');
        const outputContainer = document.getElementById('outputContainer');
        const generateBtn = document.getElementById('generateBtn');
        const outputTitle = document.getElementById('outputTitle');
        const printBtn = document.getElementById('printBtn');

        const wait = (attempt) => new Promise(r => setTimeout(r, Math.pow(2, attempt) * 500));

        function getStructuredSchema(type) {
            if (type === 'presentation') {
                return {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                slideNumber: { type: "INTEGER" },
                                slideTitle: { type: "STRING" },
                                keyPoints: { type: "ARRAY", items: { type: "STRING" } },
                                visualIdea: { type: "STRING" }
                            },
                            required: ["slideTitle", "keyPoints", "visualIdea"]
                        }
                    }
                };
            }
            return null;
        }

        function buildPrompts(grade, subject, lesson, type, outputLanguage) {
            const baseInstruction = `You are an expert Moroccan teacher assistant. Generate educational content for ${subject}, appropriate for ${grade}.`;

            if (type === 'presentation') {
                return {
                    systemInstruction: baseInstruction + ` Use LaTeX notation for all math (e.g., $\\sqrt{a}$, $7^2=49$). Return valid JSON.`,
                    userQuery: `Create a 7-slide presentation on "${lesson}" in ${outputLanguage}, keeping all LaTeX intact.`
                };
            } else {
                return {
                    systemInstruction: baseInstruction + ` Keep LaTeX math notation unchanged (e.g., $\\sqrt{49}$).`,
                    userQuery: `Generate a simple text summary for "${lesson}" in ${outputLanguage}. Keep math symbols intact.`
                };
            }
        }

        function renderContent(content, _, type, outputLanguage) {
            outputContainer.innerHTML = '';
            const isRTL = outputLanguage.includes('Arabic');
            outputContainer.className = `text-gray-700 space-y-6 ${isRTL ? 'rtl' : ''}`;
            let html = '';

            if (type === 'summary') {
                html = `<div class="p-4 bg-gray-50 border-l-4 border-morocco-blue rounded-r-lg">
                            <p class="text-lg whitespace-pre-wrap leading-relaxed">${content}</p>
                        </div>`;
            } else {
                html = content.map((slide, i) => `
                    <div class="p-6 bg-white rounded-xl shadow-md border-t-4 border-morocco-gold">
                        <p class="text-sm font-bold text-morocco-gold mb-1">SLIDE ${slide.slideNumber || i + 1}/7</p>
                        <h3 class="text-xl font-bold text-morocco-blue mb-3">${slide.slideTitle}</h3>
                        <ul class="list-disc pl-5 text-sm space-y-1">
                            ${slide.keyPoints.map(pt => `<li>${pt}</li>`).join('')}
                        </ul>
                        <div class="p-3 bg-gray-100 rounded-lg text-xs italic mt-3">**Visual Suggestion:** ${slide.visualIdea}</div>
                    </div>
                `).join('');
            }

            outputContainer.innerHTML = html;
            printBtn.classList.remove('hidden');
            MathJax.typesetPromise(); // ‚úÖ re-render LaTeX dynamically
        }

        async function generateContent() {
            printBtn.classList.add('hidden');
            const grade = document.getElementById('grade').value;
            const subject = document.getElementById('subject').value.trim();
            const lesson = document.getElementById('lesson').value.trim();
            const type = document.getElementById('outputType').value;
            const lang = document.getElementById('outputLanguage').value;

            if (!subject || !lesson) return outputContainer.innerHTML = '<p class="text-red-500 text-center">Please fill in all fields.</p>';

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            outputContainer.innerHTML = '';

            const { systemInstruction, userQuery } = buildPrompts(grade, subject, lesson, type, lang);
            const schema = getStructuredSchema(type);
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
            if (schema) payload.generationConfig = schema;

            let result;
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    await wait(attempt);
                    const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error(res.statusText);
                    result = await res.json(); break;
                } catch (err) {
                    if (attempt === 2) result = { error: err.message };
                }
            }

            loadingIndicator.classList.add('hidden');
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Resource';

            if (result.error) return outputContainer.innerHTML = `<p class="text-red-500 text-center">${result.error}</p>`;

            try {
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (type === 'presentation') renderContent(JSON.parse(text), [], type, lang);
                else renderContent(text, [], type, lang);
            } catch (e) {
                outputContainer.innerHTML = `<p class="text-red-500 text-center">Error parsing response.</p>`;
            }
        }

        generateBtn.addEventListener('click', generateContent);
        printBtn.addEventListener('click', () => window.print());
    </script>
</body>
</html>
