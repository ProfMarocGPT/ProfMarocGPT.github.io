<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfMarocGPT V1.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'morocco-blue': '#1a2e4f',
                        'morocco-gold': '#ffc107',
                        'morocco-green': '#008000',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loading-dots div {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background-color: #ffc107;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots div:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        /* Ensure Arabic/Darija content displays right-to-left */
        .rtl { direction: rtl; text-align: right; }

        /* Style for the citation container */
        .citations-container {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .citation-link {
            color: #1a2e4f;
            text-decoration: underline;
        }

        /* Print styles: Hide control panel and buttons when printing */
        @media print {
            .no-print {
                display: none !important;
            }
            main.grid {
                display: block; /* Remove grid for printing to use full width */
            }
            section.lg\\:col-span-2 {
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10 p-6 bg-morocco-blue text-white rounded-xl shadow-lg no-print">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-1">ProfMarocGPT V1.5 üá≤üá¶</h1>
            <p class="text-morocco-gold text-lg">ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÑÿ™ÿπŸÑŸÖ ŸÖÿ™ŸÖŸäÿ≤ ŸàŸáÿßÿØŸÅ.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Control Panel (Input) - Added 'no-print' class -->
            <section class="lg:col-span-1 p-6 bg-white rounded-xl shadow-2xl h-fit sticky top-8 no-print">
                <h2 class="text-2xl font-bold text-morocco-blue mb-5 border-b pb-3">Lesson Details</h2>

                <div class="space-y-4">
                    <!-- Grade Select -->
                    <div>
                        <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Grade Level</label>
                        <select id="grade" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                            <option value="Primary School (CP, CE1, CE2)">Primary School</option>
                            <option value="Middle School (Coll√®ge)">Middle School</option>
                            <option value="High School (Lyc√©e)">High School</option>
                            <option value="University/Higher Education">University/Higher Education</option>
                        </select>
                    </div>

                    <!-- Subject Input -->
                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                        <input type="text" id="subject" value="Physics" placeholder="e.g., Arabic Language, Physics, History" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                    </div>

                    <!-- Lesson Input -->
                    <div>
                        <label for="lesson" class="block text-sm font-medium text-gray-700 mb-1">Lesson Topic / Title</label>
                        <input type="text" id="lesson" value="Les Atomes et Les Ions" placeholder="e.g., Photosynthesis, Verb Conjugation, Fractions" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                    </div>
                    
                    <!-- Resource Type Select (RESTORED) -->
                    <div>
                        <label for="outputType" class="block text-sm font-medium text-gray-700 mb-1">Resource Type</label>
                        <select id="outputType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                            <option value="summary">Simple Lesson Summary (Text)</option>
                            <option value="presentation">Presentation Outline (Slides)</option>
                        </select>
                    </div>
                    
                    <!-- Output Language Select -->
                    <div>
                        <label for="outputLanguage" class="block text-sm font-medium text-gray-700 mb-1">Output Language</label>
                        <select id="outputLanguage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-morocco-blue focus:border-morocco-blue transition duration-150">
                            <option value="Standard Arabic">Standard Arabic (ÿßŸÑŸÅÿµÿ≠Ÿâ)</option>
                            <option value="Moroccan Arabic (Darija)">Moroccan Arabic (ÿßŸÑÿØÿßÿ±ÿ¨ÿ©)</option>
                            <option value="French">French (Fran√ßais)</option>
                            <option value="English">English</option>
                        </select>
                    </div>

                    <!-- Generate Button -->
                    <button id="generateBtn"
                            class="w-full py-3 px-4 bg-morocco-green text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50">
                        Generate Resource
                    </button>
                </div>
            </section>

            <!-- Output Display -->
            <section class="lg:col-span-2 p-6 bg-white rounded-xl shadow-2xl">
                <h2 id="outputTitle" class="text-2xl font-bold text-morocco-blue mb-5 border-b pb-3">Generated Content</h2>
                
                <!-- PRINT BUTTON -->
                <div class="text-right mb-4">
                    <button id="printBtn" 
                            class="hidden py-2 px-4 bg-morocco-blue text-white text-sm font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50 no-print">
                        üñ®Ô∏è Print Resource
                    </button>
                </div>

                <div id="loadingIndicator" class="hidden loading-dots my-10">
                    <div class="h-4 w-4"></div>
                    <div class="h-4 w-4"></div>
                    <div class="h-4 w-4"></div>
                </div>

                <div id="outputContainer" class="text-gray-700 space-y-4">
                    <p class="text-center text-gray-500 italic">Select your lesson details and click "Generate" to create a new resource.</p>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        // Gemini API Configuration
        const apiKey = "AIzaSyDr-16AZfW9ucQO2_UVltXQz65aDh1ppiw"; // Leave as-is, the environment provides the key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Utility Functions and DOM Elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const outputContainer = document.getElementById('outputContainer');
        const generateBtn = document.getElementById('generateBtn');
        const outputTitle = document.getElementById('outputTitle');
        const printBtn = document.getElementById('printBtn'); // Reference to the new print button

        /**
         * Exponential backoff for API retries.
         * @param {number} attempt
         * @returns {Promise<void>}
         */
        const wait = (attempt) => new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 500));

        /**
         * Retrieves the specific JSON schema for the chosen output type.
         * @param {string} type - 'summary' or 'presentation'
         * @returns {object|null} The generationConfig object for the Gemini API call.
         */
        function getStructuredSchema(type) {
            if (type === 'presentation') {
                return {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        description: "A list of slides for a presentation outline.",
                        items: {
                            type: "OBJECT",
                            properties: {
                                slideNumber: { type: "INTEGER", description: "The slide index, starting at 1." },
                                slideTitle: { type: "STRING", description: "The main title of the slide." },
                                keyPoints: { type: "ARRAY", description: "3 to 5 simple, concise bullet points for the slide.", items: { type: "STRING" } },
                                visualIdea: { type: "STRING", description: "A suggested visual aid (image, diagram, chart) for this slide." }
                            },
                            required: ["slideNumber", "slideTitle", "keyPoints", "visualIdea"]
                        }
                    }
                };
            }
            // Summary uses plain text (no structured schema)
            return null;
        }

        /**
         * Constructs the system prompt and user query based on user inputs.
         * @param {string} grade
         * @param {string} subject
         * @param {string} lesson
         * @param {string} type
         * @param {string} outputLanguage
         * @returns {{systemInstruction: string, userQuery: string}}
         */
        function buildPrompts(grade, subject, lesson, type, outputLanguage) {
            const baseInstruction = `You are an expert pedagogical assistant for Moroccan teachers. Your task is to generate resources, focusing on the subject of ${subject} as taught in the Moroccan curriculum. The complexity must be appropriate for a ${grade} level.
            
            **CRITICAL CONTENT RULE:**
            The output must be accurate and based on general educational knowledge for the topic: "${lesson}".
            
            **CRITICAL FORMATTING RULES:**
            The entire response MUST be generated in ${outputLanguage}.`;

            if (type === 'summary') {
                return {
                    systemInstruction: baseInstruction + `
                        Your output must be a concise, easy-to-read lesson summary suitable for comprehension check.
                        1. The output must be **plain, clean text**.
                        2. **DO NOT** use any Markdown formatting characters (like *, **, #, ##, ###, >, ---, |).
                        3. **DO NOT** use any LaTeX or mathematical notation symbols. Use words instead of symbols where possible.`,
                    userQuery: `Generate the simple, easy-to-comprehend lesson summary for the topic: "${lesson}".`
                };
            } else if (type === 'presentation') {
                return {
                    systemInstruction: baseInstruction + `
                        Your output must be a perfectly formatted JSON array containing a 7-slide presentation outline (including a Title Slide and Conclusion Slide). Each slide must have a title, 3-5 concise key points, and a suggestion for a visual aid. The entire response must be perfectly formatted JSON according to the provided schema.`,
                    userQuery: `Generate a 7-slide presentation outline for the lesson: "${lesson}" in ${outputLanguage}.` // Language instruction in userQuery
                };
            }
        }

        /**
         * Extracts and formats grounding sources from the API response.
         * @param {object} result - The full API response object.
         * @returns {Array<object>} Formatted array of sources.
         */
        function extractSources(result) {
            // Since we removed the search tool, this will now always return an empty array,
            // but we keep the function structure for future re-integration.
            return [];
        }

        /**
         * Renders the generated content.
         * @param {object|string} content - The parsed JSON object or the raw text summary.
         * @param {Array<object>} sources - Array of sources for citation.
         * @param {string} type - The resource type.
         * @param {string} outputLanguage 
         */
        function renderContent(content, sources, type, outputLanguage) {
            outputContainer.innerHTML = '';
            
            // Determine text direction for Arabic/Darija
            const isRTL = outputLanguage.includes('Arabic');
            outputContainer.className = `text-gray-700 space-y-6 ${isRTL ? 'rtl' : ''}`;
            
            let htmlContent = '';

            if (type === 'summary') {
                outputTitle.textContent = "Lesson Summary";
                let cleanContent = content.replace(/^- /gm, '‚Ä¢ ').replace(/^\* /gm, '‚Ä¢ ');
                
                htmlContent = `
                    <div class="p-4 bg-gray-50 border-l-4 border-morocco-blue rounded-r-lg 
                        ${isRTL ? 'border-r-4 border-l-0 rounded-l-lg rounded-r-none' : ''}">
                        <p class="text-lg whitespace-pre-wrap leading-relaxed">${cleanContent}</p>
                    </div>
                `;
            } else if (type === 'presentation' && Array.isArray(content)) {
                outputTitle.textContent = "Presentation Outline (7 Slides)";

                htmlContent = content.map((slide, index) => {
                    const pointsHtml = slide.keyPoints.map(point => `<li>${point}</li>`).join('');
                    
                    return `
                        <div class="p-6 bg-white rounded-xl shadow-md border-t-4 border-morocco-gold transition duration-300 hover:shadow-xl">
                            <p class="text-sm font-bold text-morocco-gold mb-1">SLIDE ${slide.slideNumber || index + 1} / 7</p>
                            <h3 class="text-xl font-bold text-morocco-blue mb-3">${slide.slideTitle}</h3>
                            <div class="mb-4">
                                <p class="font-semibold text-gray-800 mb-1">Key Points:</p>
                                <ul class="${isRTL ? 'list-disc pr-5' : 'list-disc pl-5'} text-sm space-y-1">
                                    ${pointsHtml}
                                </ul>
                            </div>
                            <div class="p-3 bg-gray-100 rounded-lg text-xs italic">
                                **Visual Suggestion:** ${slide.visualIdea}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            outputContainer.innerHTML = htmlContent;

            // Since sources is now an empty array, the citation block won't render.
            
            // Show the print button when content is successfully rendered
            printBtn.classList.remove('hidden');
        }

        /**
         * Triggers the browser's native print function.
         */
        function printResource() {
            window.print();
        }

        // Main Content Generation Function
        async function generateContent() {
            // Hide print button immediately on start
            printBtn.classList.add('hidden');
            
            const grade = document.getElementById('grade').value;
            const subject = document.getElementById('subject').value.trim();
            const lesson = document.getElementById('lesson').value.trim();
            const outputType = document.getElementById('outputType').value; // Get resource type
            const outputLanguage = document.getElementById('outputLanguage').value;

            if (!subject || !lesson) {
                outputContainer.innerHTML = '<p class="text-red-500 text-center">Please provide a Subject and a Lesson Topic.</p>';
                return;
            }

            // UI State Change (Loading)
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            outputContainer.innerHTML = '';
            loadingIndicator.classList.remove('hidden');

            const { systemInstruction, userQuery } = buildPrompts(grade, subject, lesson, outputType, outputLanguage);
            const generationConfig = getStructuredSchema(outputType);
            
            // CONFIGURE PAYLOAD WITHOUT SEARCH TOOL
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                // Removed: tools: [{ "google_search": {} }] 
            };
            
            if (generationConfig) {
                payload.generationConfig = generationConfig;
            }
            
            // Exponential backoff loop
            let response, result;
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    await wait(attempt);
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        result = await response.json();
                        break; 
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        continue;
                    } else {
                        // Throw the error with status and text for clearer debugging
                        throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    result = { error: error.message }; 
                    break;
                }
            }


            // UI State Change (Finished)
            loadingIndicator.classList.add('hidden');
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Resource';

            if (result.error) {
                // If it fails again, display the specific error message to the user
                outputContainer.innerHTML = `<p class="text-red-500 text-center">Generation Failed: ${result.error}</p>
                                             <p class="text-sm text-gray-500 text-center mt-2">If the error persists, please try a different subject or language.</p>`;
                return;
            }

            try {
                const textPart = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                // Sources will be an empty array now, as the tool is removed.
                const sources = extractSources(result); 

                if (!textPart) {
                    throw new Error("Received an empty response from the AI.");
                }

                if (outputType === 'summary') {
                    // Summary is plain text
                    renderContent(textPart, sources, outputType, outputLanguage);
                } else if (outputType === 'presentation') {
                    // Presentation is JSON
                    const parsedContent = JSON.parse(textPart);
                    renderContent(parsedContent, sources, outputType, outputLanguage);
                }

            } catch (e) {
                console.error("Error processing AI response:", e);
                console.log("Raw Text Received:", result?.candidates?.[0]?.content?.parts?.[0]?.text);
                outputContainer.innerHTML = `<p class="text-red-500 text-center">Error: Could not process AI response for a ${outputType}. The model may have returned invalid JSON or the connection was interrupted. Please try again.</p>`;
            }
        }
        
        // Attach event listeners
        generateBtn.addEventListener('click', generateContent);
        printBtn.addEventListener('click', printResource);
    </script>
</body>
</html>
